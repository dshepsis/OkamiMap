<!DOCTYPE HTML>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Okami Map - Test</title>
  <meta name="description" content="Map of treasure, clovers, etc. in Okami">
  <meta name="author" content="Daniel Shepsis">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!--Favicon.io-->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="manifest" href="./site.webmanifest">

  <!--Leaflet.js-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin=""/>
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>

  <script src="./Leaflet.moduleTest.js"></script>

<style>
* {
  box-sizing: border-box;
}
html {
  background: #f8f8f8;
  height:100%;
  margin: 0;
}
body {
  margin: 0;
  height: 100%;
}
#map {
  height: 100%;
}
input[type="text"] {
  width: 5em;
}
</style>
</head>

<body>
  <!-- <input id="mapHex" type="text" value="0xf02" />
  <input id="mapDec" type="text" value="3842" /> -->
  <div id="map"></div>

<script>

const bScale = 8000;
const zoomGranularity = 0.5;
const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -6,
  maxZoom: -1,
  zoomSnap: zoomGranularity,
  zoomDelta: zoomGranularity,
  // maxBounds: [[-bScale, -bScale], [bScale, bScale]],
  maxBoundsViscosity: 1,
  layerPreview: true
});
map.setView([0, 0], 0);

var ZoomViewer = L.Control.extend({
  onAdd: function(){
    var gauge = L.DomUtil.create('div');
    gauge.style.width = '200px';
    gauge.style.background = 'rgba(255,255,255,0.5)';
    gauge.style.textAlign = 'left';
    const update = function(ev){
      gauge.innerHTML = 'Zoom level: ' + map.getZoom();
    };
    update();
    map.on('zoomstart zoom zoomend', update)
    return gauge;
  }
});
(new ZoomViewer).addTo(map);

/* Thumbnail experimentation. TODO: Remove: */
// L.Control.MarkerThumbnail = L.Control.extend({
//   onAdd: function(map) {
//     var img = L.DomUtil.create('img');
    
//     img.src = './favicon-32x32.png';
//     img.style.width = '200px';
    
//     return img;
//   },
  
//   onRemove: function(map) {
//     // Nothing to do here
//   }
// });

// L.control.markerThumbnail = function(opts) {
//   return new L.Control.MarkerThumbnail(opts);
// }

// L.control.markerThumbnail({ position: 'bottomright' }).addTo(map);

const scale = 5200;
const shiftN = 1000;
const shiftE = 1000;
const bounds = [[-scale + shiftN, -scale + shiftE], [scale + shiftN, scale + shiftE]];

const mapID = 0xf02;
const mapIDHex = mapID.toString(16);

const image = L.imageOverlay(`./DumpedMaps/map_r${mapIDHex}_0out.png`, bounds).addTo(map);
map.fitBounds(bounds, {animate: false});

/* Fetch multiple JSON files in parallel */
async function paraFetchJSON(...URLs) {
  const requests = URLs.map(u=>
    fetch(u).then(r=>r.json())
  );
  return Promise.all(requests);
}

let lootData;
let mapIDMap;
(async ()=>{
  let response;
  [lootData, mapIDMap] = await paraFetchJSON(
    './lootData.json', './mapIDMap.json'
  );
  const loots = [];
  for (const loot of lootData) {
    if (loot.mapID === mapID) {
      const coords = loot.coords;
      const latlong = [-coords[2], coords[0]];
      loots.push(
        L.marker(latlong, {image: loot.image}).bindPopup(`${loot.contents} @${loot.coords}`)
      );
    }
  }
  map.lootLayer = L.featureGroup(loots).addTo(map);

  function updatePreview(e) {
    map.setPreviewImage(e.sourceTarget.options.image);
  }
  map.lootLayer.on('popupopen', updatePreview);
})();

// function selectMap(e) {
//   const selectedMapID = parseInt(e.target.value);
//   const selectedMapIDHex = selectedMapID.toString(16);
//   mapHex.value = "0x" + selectedMapIDHex;
//   mapDec.value = selectedMapID;
//   image.setUrl(`./DumpedMaps/map_r${selectedMapIDHex}_0out.png`)
// }

// mapHex.addEventListener('change', selectMap);
// mapDec.addEventListener('change', selectMap);

</script>
  
</body>
</html>
